<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSM Data Explorer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        #map { 
            height: 100vh; 
            width: 100%; 
            z-index: 0;
        }
        
        .search-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            max-width: 64rem;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white shadow-2xl p-6 md:p-8 relative z-10">
        <div class="max-w-7xl mx-auto text-center md:text-left">
            <h1 class="text-3xl md:text-5xl font-black mb-2 drop-shadow-lg">
                üåç OSM Data Explorer
            </h1>
            <p class="text-lg md:text-xl opacity-95 max-w-3xl mx-auto md:mx-0 leading-relaxed">
                D√©crivez ce que vous voulez voir en langage naturel (ex: "bus stops in Bordeaux" ou "schools and parks in Paris") et regardez-le appara√Ætre sur une belle carte Voyager.
            </p>
            <p class="text-sm md:text-base mt-4 opacity-80 italic">
                R√©cup√®re des donn√©es en temps r√©el via l'API Overpass. Le zoom s'ajuste automatiquement!
            </p>
        </div>
    </header>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Search Panel -->
    <div class="search-panel">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/50 p-6 md:p-8">
            <div class="space-y-6">
                <!-- Input Section -->
                <div>
                    <label class="block text-gray-800 text-xl font-bold mb-4 text-center md:text-left">
                        üîç Que voulez-vous explorer?
                    </label>
                    <input
                        type="text"
                        id="searchInput"
                        value="bus stops in Bordeaux"
                        class="w-full px-6 py-4 text-lg bg-gradient-to-r from-gray-50 to-blue-50 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-transparent shadow-xl transition-all duration-300 placeholder-gray-500 font-medium"
                        placeholder="Essayez: bus, school, restaurant, park... in your city"
                    />
                </div>

                <!-- Search Button -->
                <button
                    id="searchButton"
                    class="w-full py-4 px-8 bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 text-white font-extrabold text-lg rounded-2xl shadow-2xl hover:shadow-3xl transform hover:scale-105 active:scale-95 transition-all duration-300 flex items-center justify-center gap-3 uppercase tracking-wide"
                >
                    üöÄ Lancer la recherche
                </button>

                <!-- Error Display -->
                <div id="errorDisplay" class="hidden p-6 bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-2xl shadow-md">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <h3 class="font-bold text-red-800 text-lg">Probl√®me de requ√™te</h3>
                    </div>
                    <p id="errorMessage" class="text-red-700 leading-relaxed whitespace-pre-wrap"></p>
                </div>

                <!-- Supported Topics -->
                <div class="p-4 bg-blue-50/50 border border-blue-200 rounded-2xl text-sm md:text-base space-y-2">
                    <p class="font-semibold text-blue-800 flex items-center gap-2">
                        üìã Sujets support√©s (combinez-les!)
                    </p>
                    <p class="text-blue-700 pl-6">
                        bus, stop, school, university, college, pathway, footway, sidewalk, cycleway, bike, 
                        restaurant, cafe, bar, park, hospital, clinic, shop, store, atm, bank, hotel
                    </p>
                    <p class="text-gray-600 text-xs italic mt-2">
                        Les sujets ne sont pas sensibles √† la casse et peuvent √™tre combin√©s (ex: "bus and school in Tokyo").
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Counter -->
    <div id="resultsCounter" class="hidden absolute bottom-6 right-6 z-30">
        <div class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl p-4 md:p-6 border border-gray-200/50 space-y-3 min-w-[200px]">
            <div class="flex items-center justify-between gap-2 mb-3">
                <span class="text-2xl font-bold text-green-600">üéØ</span>
                <span id="resultCount" class="text-lg font-bold text-gray-800">0</span>
                <span class="text-sm text-gray-600">r√©sultats</span>
            </div>
            <button
                id="fitButton"
                class="w-full py-3 px-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-2 text-sm uppercase tracking-wide"
            >
                üìê Ajuster aux marqueurs
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="bg-white/90 backdrop-blur-xl rounded-3xl p-8 shadow-3xl text-center space-y-4 border-2 border-indigo-200">
            <div class="spinner"></div>
            <p class="text-xl font-semibold text-gray-700">R√©cup√©ration des donn√©es OpenStreetMap...</p>
            <p class="text-sm text-gray-500">Cela peut prendre quelques secondes pour les grandes zones.</p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration
        const topicMappings = {
            bus: '["highway"="bus_stop"]',
            stop: '["highway"="bus_stop"]',
            school: '["amenity"="school"]',
            university: '["amenity"="university"]',
            college: '["amenity"="college"]',
            pathway: '["highway"="pathway"]',
            footway: '["highway"="footway"]',
            sidewalk: '["highway"="footway"]',
            cycleway: '["highway"="cycleway"]',
            bike: '["highway"="cycleway"]',
            restaurant: '["amenity"="restaurant"]',
            cafe: '["amenity"="cafe"]',
            bar: '["amenity"="bar"]',
            park: '["leisure"="park"]',
            hospital: '["amenity"="hospital"]',
            clinic: '["amenity"="clinic"]',
            // CORRECTION: Syntaxe correcte pour rechercher n'importe quelle boutique.
            // On retire les guillemets autour de "shop".
            shop: '[shop]',
            store: '[shop]',
            atm: '["amenity"="atm"]',
            bank: '["amenity"="bank"]',
            hotel: '["tourism"="hotel"]',
        };

        // Initialize map
        const map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);

        // Fix Leaflet icons
        const iconRetinaUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png';
        const iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png';
        const shadowUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png';
        
        L.Icon.Default.mergeOptions({
            iconRetinaUrl,
            iconUrl,
            shadowUrl,
        });

        // Global variables
        let markers = [];
        let features = [];

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resultsCounter = document.getElementById('resultsCounter');
        const resultCount = document.getElementById('resultCount');
        const fitButton = document.getElementById('fitButton');

        // Parse query function
        function parseQuery(query) {
            const lower = query.toLowerCase().trim();
            const inMatch = lower.match(/(.+?)\s+in\s+(.+)$/i);
            
            if (!inMatch) {
                throw new Error('Format de requ√™te: "topics in city", ex: "bus stops in Bordeaux"');
            }
            
            const topicPart = inMatch[1].trim();
            const cityPart = inMatch[2].trim();
            
            if (!topicPart || !cityPart) {
                throw new Error('Le sujet et la ville sont requis.');
            }
            
            const topicWords = topicPart
                .split(/[,\s]+and[,\s]+|[,\s]+|\band\b/)
                .map(w => w.trim())
                .filter(w => w.length > 0);
            
            const tagFiltersSet = new Set();
            topicWords.forEach(word => {
                const mapping = topicMappings[word];
                if (mapping) {
                    tagFiltersSet.add(mapping);
                }
            });
            
            if (tagFiltersSet.size === 0) {
                throw new Error(`Aucun sujet correspondant trouv√© dans "${topicPart}". Sujets support√©s: ${Object.keys(topicMappings).join(', ')}`);
            }
            
            return {
                tagFilters: Array.from(tagFiltersSet),
                city: cityPart
            };
        }

        // Calculate zoom for bbox
        function getZoomForBbox(south, west, north, east) {
            const latDiff = north - south;
            const lonDiff = east - west;
            const avgLat = (south + north) / 2;
            const adjustedLonDiff = lonDiff / Math.cos((avgLat * Math.PI) / 180);
            const maxDiff = Math.max(latDiff, adjustedLonDiff);
            
            if (maxDiff <= 0.001) return 18;
            if (maxDiff <= 0.01) return 16;
            if (maxDiff <= 0.1) return 13;
            if (maxDiff <= 1) return 10;
            if (maxDiff <= 5) return 8;
            if (maxDiff <= 10) return 6;
            return 4;
        }

        // Clear markers
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // Handle search
        async function handleSearch() {
            errorDisplay.classList.add('hidden');
            clearMarkers();
            features = [];
            loadingOverlay.classList.remove('hidden');
            resultsCounter.classList.add('hidden');
            
            try {
                const parsed = parseQuery(searchInput.value);
                const { tagFilters, city } = parsed;
                
                // Geocode city
                const nomUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1&addressdetails=1`;
                const nomRes = await fetch(nomUrl);
                
                if (!nomRes.ok) {
                    throw new Error(`√âchec du g√©ocodage: ${nomRes.statusText}`);
                }
                
                const nomData = await nomRes.json();
                if (nomData.length === 0) {
                    throw new Error(`Aucun lieu trouv√© pour la ville '${city}'. Essayez un nom plus sp√©cifique.`);
                }
                
                const place = nomData[0];
                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);
                const boundingbox = place.boundingbox;
                const south = parseFloat(boundingbox[0]);
                const north = parseFloat(boundingbox[1]);
                const west = parseFloat(boundingbox[2]);
                const east = parseFloat(boundingbox[3]);
                const bbox = `${south},${west},${north},${east}`;
                
                // Set map view
                const calculatedZoom = getZoomForBbox(south, west, north, east);
                map.setView([lat, lon], calculatedZoom);
                
                // Query Overpass API
                const nodeQueries = tagFilters.map(filter => `node${filter}(${bbox})`).join('; ');
                const query = `[out:json][timeout:30];\n(\n  ${nodeQueries};\n);\nout geom;`;
                
                // CORRECTION: Utilisation d'une requ√™te POST, qui est plus robuste.
                const opUrl = 'https://overpass-api.de/api/interpreter';
                const opRes = await fetch(opUrl, {
                    method: 'POST',
                    body: `data=${encodeURIComponent(query)}`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    },
                });

                if (!opRes.ok) {
                    // Tente de r√©cup√©rer un message d'erreur plus d√©taill√© du corps de la r√©ponse
                    const errorBody = await opRes.text();
                    console.error("Overpass API Error Body:", errorBody);
                    throw new Error(`Erreur API Overpass: ${opRes.statusText}. Le serveur a r√©pondu: ${errorBody.substring(0, 200)}`);
                }
                
                const opData = await opRes.json();
                const elements = opData.elements || [];
                
                // Process features
                features = elements
                    .filter(el => el.type === 'node' && typeof el.lat === 'number' && typeof el.lon === 'number')
                    .map(el => ({
                        position: [el.lat, el.lon],
                        name: el.tags?.name || '√âl√©ment sans nom',
                        tags: el.tags || {}
                    }));
                
                // Add markers to map
                features.forEach(feature => {
                    const marker = L.marker(feature.position).addTo(map);
                    
                    // Create popup content
                    let popupContent = `
                        <div style="font-family: system-ui, -apple-system, sans-serif; line-height: 1.4;">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 6px;">
                                üìç ${feature.name}
                            </h3>
                    `;
                    
                    if (Object.entries(feature.tags).length > 0) {
                        popupContent += '<div style="font-size: 14px;">';
                        Object.entries(feature.tags).forEach(([key, value]) => {
                            popupContent += `
                                <div style="margin-bottom: 8px; padding: 6px; background-color: #f8fafc; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                    <span style="color: #374151; font-weight: 600; font-size: 13px;">${key}:</span>
                                    <span style="color: #4b5563;">${value}</span>
                                </div>
                            `;
                        });
                        popupContent += '</div>';
                    } else {
                        popupContent += `
                            <p style="font-size: 14px; color: #6b7280; font-style: italic; text-align: center; padding: 20px; background-color: #fef3c7;">
                                Aucun d√©tail suppl√©mentaire disponible. C'est un point d'int√©r√™t basique.
                            </p>
                        `;
                    }
                    
                    popupContent += '</div>';
                    
                    marker.bindPopup(popupContent, {
                        maxWidth: 350,
                        minWidth: 250
                    });
                    
                    markers.push(marker);
                });
                
                // Update results counter
                if (features.length > 0) {
                    resultCount.textContent = features.length;
                    resultsCounter.classList.remove('hidden');
                }
                
            } catch (err) {
                errorMessage.textContent = err.message || 'Une erreur inattendue s\'est produite.';
                errorDisplay.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Event listeners
        searchButton.addEventListener('click', handleSearch);
        
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        
        fitButton.addEventListener('click', () => {
            if (features.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        });
        
        // Initial search on page load
        window.addEventListener('load', () => {
            // Optionnel: Effectuer une recherche initiale au chargement.
            // D√©commenter la ligne suivante pour cela.
            // handleSearch();
        });
    </script>
</body>
</html>
